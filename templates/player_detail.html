{% extends "base.html" %}

{% block title %}{{ player.name }} - Player Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>{{ player.name }} - Player Details
                </h5>
                <div>
                    {% if session.get('is_admin') %}
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editPlayerInfo()">
                        <i class="fas fa-edit me-1"></i>Edit Info
                    </button>
                    {% endif %}
                    <a href="{{ url_for('ledger') }}" class="btn btn-outline-secondary btn-sm ms-2">
                        <i class="fas fa-arrow-left me-1"></i>Back to Ledger
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Player Summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Profit/Loss</h6>
                                {% set current_balance = ledger_entries[0].running_balance if ledger_entries else 0 %}
                                <h4 class="{{ 'positive' if current_balance >= 0 else 'negative' }}">
                                    {{ "${:,.2f}".format(current_balance) }}
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Payments</h6>
                                {% set total_payments = payments|sum(attribute='amount') %}
                                <h4 class="text-success">{{ "${:,.2f}".format(total_payments) }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Current Balance</h6>
                                {% set remaining_payment = current_balance + total_payments %}
                                {% if remaining_payment < 0 and remaining_payment > -0.01 %}
                                    {% set remaining_payment = 0.0 %}
                                {% endif %}
                                <h4 class="{{ 'positive' if remaining_payment >= 0 else 'negative' }}">
                                    {{ "${:,.2f}".format(remaining_payment) }}
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Games Played</h6>
                                <h4 class="text-primary">{{ ledger_entries|length }}</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Preferences -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>Payment Preferences
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Preferred Payment Method:</strong> 
                                        {% if player.preferred_payment_method %}
                                            {{ player.preferred_payment_method }}
                                        {% else %}
                                            <span class="text-muted">Not set</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Payment ID:</strong> 
                                        {% if player.payment_id %}
                                            {{ player.payment_id }}
                                        {% else %}
                                            <span class="text-muted">Not set</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ledger Entries -->
                <div class="row">
                    <div class="col-md-8">
                        <h6><i class="fas fa-list me-2"></i>Game History</h6>
                        {% if ledger_entries %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Net Profit/Loss</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in ledger_entries %}
                                        <tr>
                                            <td>{{ entry.game_date.strftime('%Y-%m-%d') }}</td>
                                            <td class="{{ 'positive' if entry.net_profit >= 0 else 'negative' }}">
                                                {{ "${:,.2f}".format(entry.net_profit) }}
                                            </td>
                                            <td>
                                                {% if session.get('is_admin') %}
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        onclick="editEntry({{ entry.id }}, {{ entry.net_profit }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <!-- Summary row -->
                                    <tr class="table-info">
                                        <td><strong>Total Net Profit/Loss (Games Only)</strong></td>
                                        <td class="{{ 'positive' if total_net_profit >= 0 else 'negative' }}">
                                            <strong>{{ "${:,.2f}".format(total_net_profit) }}</strong>
                                        </td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <p class="text-muted">No game history available.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Payment History -->
                    <div class="col-md-4">
                        <h6><i class="fas fa-credit-card me-2"></i>Payment History</h6>
                        {% if payments %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in payments %}
                                    <tr>
                                        <td>{{ payment.payment_date.strftime('%Y-%m-%d') }}</td>
                                        <td class="{{ 'text-success' if payment.amount >= 0 else 'text-danger' }}">
                                            {{ "${:,.2f}".format(payment.amount) }}
                                        </td>
                                        <td>
                                            {% if payment.payment_method %}
                                                <span class="badge bg-secondary">{{ payment.payment_method }}</span>
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <p class="text-muted">No payments recorded.</p>
                        </div>
                        {% endif %}

                        <!-- Add Payment Button -->
                        {% if session.get('is_admin') %}
                        <div class="mt-3">
                            <button type="button" class="btn btn-success btn-sm w-100" 
                                    onclick="addPayment({{ player.id }}, '{{ player.name }}')">
                                <i class="fas fa-plus me-1"></i>Record Payment
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Player Info Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_player') }}">
                <div class="modal-body">
                    <input type="hidden" name="player_id" value="{{ player.id }}">
                    <div class="mb-3">
                        <label for="preferred_payment_method" class="form-label">Preferred Payment Method</label>
                        <select class="form-select" id="preferred_payment_method" name="preferred_payment_method">
                            <option value="">Select payment method...</option>
                            <option value="Cash" {{ 'selected' if player.preferred_payment_method == 'Cash' }}>Cash</option>
                            <option value="Venmo" {{ 'selected' if player.preferred_payment_method == 'Venmo' }}>Venmo</option>
                            <option value="Zelle" {{ 'selected' if player.preferred_payment_method == 'Zelle' }}>Zelle</option>
                            <option value="PayPal" {{ 'selected' if player.preferred_payment_method == 'PayPal' }}>PayPal</option>
                            <option value="Check" {{ 'selected' if player.preferred_payment_method == 'Check' }}>Check</option>
                            <option value="Other" {{ 'selected' if player.preferred_payment_method == 'Other' }}>Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="payment_id" class="form-label">Payment ID</label>
                        <input type="text" class="form-control" id="payment_id" name="payment_id" 
                               value="{{ player.payment_id or '' }}" 
                               placeholder="Venmo ID, phone number, email, etc.">
                        <div class="form-text">
                            Enter Venmo ID, phone number for Zelle, email for PayPal, etc.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Information</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Entry Modal -->
<div class="modal fade" id="editEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Ledger Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_ledger_entry') }}">
                <div class="modal-body">
                    <input type="hidden" id="edit_entry_id" name="entry_id">
                    <div class="mb-3">
                        <label for="edit_net_profit" class="form-label">Net Profit/Loss</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="edit_net_profit" name="net_profit" 
                                   step="0.01" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_payment') }}">
                <div class="modal-body">
                    <input type="hidden" name="player_id" value="{{ player.id }}">
                    <div class="mb-3">
                        <label for="payment_amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="payment_amount" name="amount" 
                                   step="0.01" required>
                        </div>
                        <div class="form-text">
                            Use positive amounts for payments. Leave recipient blank for bank payments.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="payment_recipient" class="form-label">Payment To (Optional)</label>
                        <select class="form-select" id="payment_recipient" name="transfer_to_player_id">
                            <option value="">Bank/General Payment</option>
                        </select>
                        <div class="form-text">
                            Select another player to record a transfer. Leave blank for bank payments.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="payment_date" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method (Optional)</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="">Not specified</option>
                            <option value="Cash">Cash</option>
                            <option value="Venmo">Venmo</option>
                            <option value="Zelle">Zelle</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Check">Check</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editPlayerInfo() {
    const modal = new bootstrap.Modal(document.getElementById('editPlayerModal'));
    modal.show();
}

function editEntry(entryId, currentNet) {
    document.getElementById('edit_entry_id').value = entryId;
    document.getElementById('edit_net_profit').value = currentNet;
    
    const modal = new bootstrap.Modal(document.getElementById('editEntryModal'));
    modal.show();
}

function addPayment(playerId, playerName) {
    document.getElementById('payment_date').value = new Date().toISOString().split('T')[0];
    
    // Populate recipient dropdown with all players except the current one
    const recipientSelect = document.getElementById('payment_recipient');
    recipientSelect.innerHTML = '<option value="">Bank/General Payment</option>';
    
    // Fetch all players from API
    fetch('/api/players')
        .then(response => response.json())
        .then(players => {
            players.forEach(player => {
                if (player.id != playerId) {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.name;
                    recipientSelect.appendChild(option);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching players:', error);
        });
    
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}
</script>
{% endblock %} 